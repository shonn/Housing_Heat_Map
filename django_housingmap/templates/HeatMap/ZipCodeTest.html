<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		html { height: 100% }
		body {height: 100%; margin: 0; padding: 0 }
		#map-canvas { height: 90%; width:100%;}
		#debug{height: 10%; width:100%; overflow:auto}
	</style>
	<script type="text/javascript" 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_JEN1JLQ2C341o4pAuyd04GSYd-Q89Lg&libraries=drawing&sensor=false">
	</script>
	<script type="text/javascript"
		src="/home/GeoJSON.js">
	</script>
	<script type="text/javascript">
	function initialize() {		
		//Map Information
		  var myLatLng = new google.maps.LatLng(37.42291810, -122.08542120);
		  var mapOptions = {
		    zoom: 15,
		    center: myLatLng,
		    mapTypeId: google.maps.MapTypeId.TERRAIN
		  };

		  var map = new google.maps.Map(document.getElementById("map-canvas"),
		      mapOptions);		
		var googleMapsVector={};
		
		google.maps.event.addListener(map,'idle', function(){		
		  		document.getElementById('debug').innerHTML += "Idle<br/>";
				// asynchronous json request      
				var xhr = new XMLHttpRequest();
				document.getElementById('debug').innerHTML += "Fetching JSON<br/>";
				xhr.open("POST", "{% url 'HeatMap:price_growth_in_bounding_box_to_geojson' %}", true);
				xhr.onload = function() {
					document.getElementById('debug').innerHTML += "Recieved JSON<br/>";
					var response = this.responseText;
					var result = JSON.parse(response);
			
					var shapeOptions = {
  						strokeColor: "#FF0000",
		    			strokeOpacity: 0.8,
		    			strokeWeight: 2,
		    			fillColor: "#FF0000",
		    			fillOpacity: 0.35
					};
					
					// remove existing shapes: overlapping shapes increase opacity
					for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
							googleMapsVector[i][j].setMap(null);
						}
					}
					
					// get google map shapes from results
					googleMapsVector = new GeoJSON(result, shapeOptions);
			
					// TODO: assign proper colors to the shapes
					
					
					// assign the shapes to map
					for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
							googleMapsVector[i][j].setMap(map);
						}
					}
				};
				var myForm = new FormData();
				myForm.append('northLatitude',map.getBounds().getNorthEast().lat());
				myForm.append('southLatitude',map.getBounds().getSouthWest().lat());
				myForm.append('westLongitude',map.getBounds().getSouthWest().lng());
				myForm.append('eastLongitude',map.getBounds().getNorthEast().lng());
				xhr.send(myForm);
		  	});

		  	
		  google.maps.event.addListener(map, 'bounds_changed', function() {
        	 document.getElementById("debug").innerHTML += "Bounds changed<br/>";
      		});
		}
		google.maps.event.addDomListener(window,'load',initialize);
	</script>
</head>
<body>
		<div id="debug">
		</div>
		<div id="map-canvas">this is the map</div>
</body>
</html>