<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		html { height: 100% }
		body {height: 100%; margin: 0; padding: 0 }
		#map-canvas { height: 100%; width:80%; float:right;}
		#side-panel{height: 100%; width:20%; overflow:auto; float:left;}
	</style>
	<script type="text/javascript" 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_JEN1JLQ2C341o4pAuyd04GSYd-Q89Lg&libraries=drawing&sensor=false">
	</script>
	<script type="text/javascript"
		src="/home/GeoJSON.js">
	</script>
	<script type="text/javascript">
	var year1 = 1998;
	var year2 = 2013;
	function initialize() {		
		//Map Information
		  var myLatLng = new google.maps.LatLng(37.42291810, -122.08542120);
		  var mapOptions = {
		    zoom: 10,
		    center: myLatLng,
		    mapTypeId: google.maps.MapTypeId.TERRAIN
		  };

		  var map = new google.maps.Map(document.getElementById("map-canvas"),
		      mapOptions);		
		var googleMapsVector={};
		
		var polygonRequest = new XMLHttpRequest();
		polygonRequest.onload = function() {
					document.getElementById('debug').innerHTML += "Recieved JSON<br/>";
					var response = this.responseText;
					//document.getElementById('debug').innerHTML += response;
					var result = JSON.parse(response);
			
					var shapeOptions = {
  						strokeColor: "rgb(255,0,0)",
		    			strokeOpacity: 0.8,
		    			strokeWeight: 2,
		    			fillColor: "rgb(255,0,0)",
		    			fillOpacity: 0.35
					};
					
					// remove existing shapes: overlapping shapes increase opacity
					for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
							googleMapsVector[i][j].setMap(null);
						}
					}
					
					// get google map shapes from results
					googleMapsVector = new GeoJSON(result, shapeOptions);
														
          //standard deviation: sqrt((sum (val - avg)^2) / n)
          //calculate average 
          var avg = 0;
          var total_len = 0
					for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
							avg = avg + googleMapsVector[i][j].geojsonProperties.value;
            }
            total_len = total_len + googleMapsVector[i].length;
          }
          avg = avg/total_len;

          var sum = 0;
          for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
              sum = sum + Math.pow(googleMapsVector[i].length - avg, 2);
            }
          }
          var scale = Math.sqrt(sum/total_len);

					// assign the shapes to map
					for(var i = 0; i < googleMapsVector.length; i++){
						for (var j = 0; j <googleMapsVector[i].length; j++){
              var val = Math.abs(googleMapsVector[i][j].geojsonProperties.value);
              var temp_scale = scale;
              var heat = 0;
              while (temp_scale < val) {
                temp_scale = temp_scale * 2;
                heat = heat + 55;
              }
							var color = "rgb("+(heat)+","+(heat)+",0)";
							googleMapsVector[i][j].setOptions({
								strokeColor: color,
								fillColor: color});
							googleMapsVector[i][j].setMap(map);
						}
					}
				};
		
		google.maps.event.addListener(map,'idle', function(){		
		  		document.getElementById('debug').innerHTML += "Idle<br/>";
				// asynchronous json request      
				document.getElementById('debug').innerHTML += "Fetching JSON<br/>";
				
				var westLongitude = map.getBounds().getSouthWest().lng();
				var southLatitude = map.getBounds().getSouthWest().lat();
				var eastLongitude = map.getBounds().getNorthEast().lng();
				var northLatitude = map.getBounds().getNorthEast().lng();
				
				document.getElementById('debug').innerHTML += 
					'Polygon((' + westLongitude + ' ' + southLatitude + ',' 
						+ westLongitude + ' ' + northLatitude + ','
						+ eastLongitude + ' ' + northLatitude + ','
						+ eastLongitude + ' ' + southLatitude + ','
						+ westLongitude + ' ' + southLatitude + '))' + '<br/>';
				
				// abort the previous request
				// prevents loading the wrong set of polygons
				// ! may or may not stop django's db request.
				polygonRequest.abort();
				//*
				var GETstring ="?westLongitude="+map.getBounds().getSouthWest().lng()
					+"&eastLongitude="+map.getBounds().getNorthEast().lng()
					+"&northLatitude="+map.getBounds().getNorthEast().lat()
					+"&southLatitude="+map.getBounds().getSouthWest().lng()
					+"&year1="+year1
					+"&year2="+year2;
				//*/
				
				document.getElementById('debug').innerHTML+= GETstring + '<br/>';
				
				polygonRequest.open("GET", "{% url 'HeatMap:price_growth_in_bounding_box_to_geojson' %}" + GETstring, true);
				polygonRequest.send();
				/*
				var myForm = new FormData();
				myForm.append('northLatitude',map.getBounds().getNorthEast().lat());
				myForm.append('southLatitude',map.getBounds().getSouthWest().lat());
				myForm.append('westLongitude',map.getBounds().getSouthWest().lng());
				myForm.append('eastLongitude',map.getBounds().getNorthEast().lng());
				xhr.send(myForm);
				//*/
		  	});
		function goButton(){
			//validate input
			if(/^ddddd$/.test(document.getElementById('input_zip'))){
				//TODO get zip coordinates, recenter map
			}
			if(/^dddd$/.test(document.getElementById('input_year1'))&&
				/^dddd$/.test(document.getElementById('input_year2'))){
				year1 = document.getElementById('input_year1');
				year2 = document.getElementById('input_year2');
			}
		}
	}
	google.maps.event.addDomListener(window,'load',initialize);
	</script>
</head>
<body>
		<div id="side-panel">
			<form id="inputs" action="">
				<fieldset>
					<label for="input_zip">Zip: </label>
					<input type="text" id="input_zip" name="input_zip"/><br/>
					
					<label for="input_year1">Year1: </label>
					<input type="text" id="input_year1" name="input_year1"/><br/>
					
					<label for="input_year2">Year2: </label>
					<input type="text" id="input_year2" name="input_year2"/><br/>
					
					<input type="button" id="go" name="go" value="Go!"/>
				</fieldset>
			</form>
			<div id="debug">
			</div>
		</div>
		<div id="map-canvas">this is the map</div>
</body>
</html>
